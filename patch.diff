From 0ca78ee11d691f7b7a1300d616e507931980d7e1 Mon Sep 17 00:00:00 2001
From: Michael Kolb <dev@db1smk.com>
Date: Mon, 3 Apr 2017 18:13:38 +0200
Subject: [PATCH] further development

---
 app.js                       |  3 ++
 package.json                 |  3 ++
 public/stylesheets/style.css | 18 ++++++-----
 views/fieldutils.pug         | 74 ++++++++++++++++++++++++++++++++++++++++++++
 views/filterview.pug         | 27 +++++-----------
 views/issuedetails.pug       | 47 ++++++++++++++--------------
 views/layout.pug             |  7 ++---
 7 files changed, 125 insertions(+), 54 deletions(-)
 create mode 100644 views/fieldutils.pug

diff --git a/app.js b/app.js
index 19bcae5..cfcebb4 100644
--- a/app.js
+++ b/app.js
@@ -34,6 +34,9 @@ var CredentialCache = require('./app/models/credentialcache');
 
 var app = express();
 
+app.locals.md = require('marked').setOptions({ breaks: true });
+app.locals.j2md = require('jira2md').to_markdown;
+app.locals.moment = require('moment');
 
 
 // view engine setup
diff --git a/package.json b/package.json
index 1397c1e..8168f3c 100644
--- a/package.json
+++ b/package.json
@@ -8,6 +8,9 @@
         "jira": "atlas-run-standalone --http-port 8080 --product jira"
     },
     "dependencies": {
+        "moment":"~2.18.1",
+        "jira2md":"~2.0.1",
+        "marked":"~0.3.6",
         "datatables.net": "~1.10.13",
         "datatables.net-bs": "~1.10.13",
         "datatables.net-colreorder": "~1.3.2",
diff --git a/public/stylesheets/style.css b/public/stylesheets/style.css
index 2d2e414..0a988bf 100644
--- a/public/stylesheets/style.css
+++ b/public/stylesheets/style.css
@@ -14,17 +14,21 @@
 //     You should have received a copy of the GNU General Public License
 //     along with this program.  If not, see <http://www.gnu.org/licenses/>.*/
 
-body {
-  padding: 50px;
-  font: 14px "Lucida Grande", Helvetica, Arial, sans-serif;
-}
 
-a {
-  color: #00B7FF;
-}
 
 .footer {
   color:#AFAFAF;
   font-size: 8pt;
   margin-top:15px;
 }
+
+.content {
+  padding-left: 25px;
+}
+
+
+.label-version {
+  background-color: white;
+  color:black;
+  border: 1px solid #000099;
+}
\ No newline at end of file
diff --git a/views/fieldutils.pug b/views/fieldutils.pug
new file mode 100644
index 0000000..f7662dc
--- /dev/null
+++ b/views/fieldutils.pug
@@ -0,0 +1,74 @@
+mixin space()
+  | !{' '}
+  
+  
+mixin duration(seconds)
+    //- calculate (and subtract) whole days
+    -var days = Math.floor(seconds / 86400);
+    -seconds -= days * 86400;
+
+    //- calculate (and subtract) whole hours
+    -var hours = Math.floor(seconds / 3600) % 24;
+    -seconds -= hours * 3600;
+
+    //- calculate (and subtract) whole minutes
+    -var minutes = Math.floor(seconds / 60) % 60;
+    -seconds -= minutes * 60;
+
+    //- what's left is seconds
+    -var seconds = seconds % 60;  // in theory the modulus is not required
+
+    span #{days}d #{hours}h #{minutes}m
+
+mixin date(date)
+  - var date=moment(date,"YYYY-MM-DDTHH:mm:ss.SSSZZ")
+  span #{date.format('LLLL')}
+
+mixin renderField(fieldname,fieldcontent)
+    case fieldname
+        when "issuekey"
+            span #{fieldcontent}
+        when "issuetype"
+            img(src=fieldcontent.iconUrl)
+            +space
+            span #{fieldcontent.name}
+        when "creator"
+        when "assignee"
+            img(src=fieldcontent.avatarUrls['48x48'], width="25px", height="25px")
+            +space
+            span #{fieldcontent.displayName}
+        when "versions"
+        when "fixVersions"
+            each version in fieldcontent
+                span.label.label-version #{version.name}
+        when "priority"
+            img(src=fieldcontent.iconUrl, width="15px", height="15px")
+            +space
+            span #{fieldcontent.name}
+        when "status"
+            case fieldcontent.name
+                when "Closed"
+                    span.label.label-success #{fieldcontent.name}
+                when "Open"
+                    span.label.label-primary #{fieldcontent.name}
+                default
+                    span.label.label-warning #{fieldcontent.name}
+        when "description"
+          if fieldcontent
+            - var text=md(j2md(fieldcontent))
+          else
+            - var text = ""
+          span !{text}
+        when "resolution"
+            if fieldcontent
+                span #{fieldcontent.name}
+        when "timeoriginalestimate"
+            +duration(fieldcontent)
+        when "timeestimate"
+            +duration(fieldcontent)
+        when "created"
+          span 
+            +date(fieldcontent)
+        default
+            span #{fieldcontent}
+
diff --git a/views/filterview.pug b/views/filterview.pug
index c95c2dc..c36220f 100644
--- a/views/filterview.pug
+++ b/views/filterview.pug
@@ -17,7 +17,7 @@
 extends layout
   
   
-  
+include fieldutils
 
 block content
   script(src="/javascripts/filterview.js")
@@ -33,22 +33,11 @@ block content
         tr(data-issue=issue)
           each field in fields
               - var fieldcontent=issue.fields[field.value]
-              case field.value
-                when "issuekey"
-                  td.details-control
-                    a #{issue.key}
-                when "issuetype"
-                  td
-                    img(src=fieldcontent.iconUrl)
-                    span #{fieldcontent.name}
-                when "assignee"
-                  td 
-                    img(src=fieldcontent.avatarUrls['48x48'], width="25px", height="25px")
-                    span #{fieldcontent.displayName}
-                when "fixVersions"
-                  td
-                    each version in fieldcontent
-                      span.label.label-primary #{version.name}
-                default
-                  td #{fieldcontent}
+              if field.value == "issuekey"
+                td.details-control
+                  a
+                    +renderField(field.value,issue.key)
+              else
+                td
+                  +renderField(field.value,fieldcontent)
         
diff --git a/views/issuedetails.pug b/views/issuedetails.pug
index 5a37151..9bcce03 100644
--- a/views/issuedetails.pug
+++ b/views/issuedetails.pug
@@ -14,29 +14,28 @@
 //-     You should have received a copy of the GNU General Public License
 //-     along with this program.  If not, see <http://www.gnu.org/licenses/>.
 
-h3 #{data.key}
-h4 #{data.fields['summary']}
-table.table
-  tbody
-    each field in fields
-      tr
-        td #{field.label}
-        - var fieldcontent=data.fields[field.value]
-        case field.value
-          when "issuekey"
-            td #{data.key}
-          when "issuetype"
-            td
-              img(src=fieldcontent.iconUrl)
-              span #{fieldcontent.name}
-          when "assignee"
-            td 
-              img(src=fieldcontent.avatarUrls['48x48'], width="25px", height="25px")
-              span #{fieldcontent.displayName}
-          when "fixVersions"
+include fieldutils
+
+
+div.panel.panel-default
+  div.panel-body
+    h4
+      span #{data.key}
+      +space
+      span.text-muted #{data.fields['summary']}
+    table.table
+      tbody
+        each field in fields
+          tr
+            td #{field.label}
             td
-              each version in fieldcontent
-                span.label.label-primary #{version.name}
-          default
-            td #{fieldcontent}
+              if field.value == "issuekey"
+                +renderField(field.value,data.key)
+              else
+                +renderField(field.value,data.fields[field.value])  
+          
+            
+
+
+        
       
diff --git a/views/layout.pug b/views/layout.pug
index 39e5384..0b11298 100644
--- a/views/layout.pug
+++ b/views/layout.pug
@@ -48,7 +48,6 @@ html
               include menuloggedin
             include loginform
       
-
-    block content
-      
-    include footer
+    div.content
+      block content
+      include footer
-- 
2.8.4 (Apple Git-73)

